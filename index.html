<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å›½èªæ•°å­—ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚²ãƒ¼ãƒ ï¼œãŠä¼šè¨ˆç·¨ï¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap');
        body { font-family: 'M PLUS Rounded 1c', sans-serif; overflow: hidden; touch-action: manipulation; }
        .money-glow { filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1)); }
        
        @keyframes talking {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.3); }
        }
        .mouth-anim {
            animation: talking 0.15s infinite;
        }

        .fade-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .tray-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .tray-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .tray-scroll::-webkit-scrollbar-thumb {
            background: rgba(186, 230, 253, 0.8);
            border-radius: 10px;
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const IconHome = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>;
        const IconInfo = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>;

        const TapiocaDrink = ({ className, color = "#5c4033", strawColor = "#ff6666" }) => (
            <svg viewBox="0 0 100 120" className={className}>
                <path d="M25 20 L75 20 L70 100 L30 100 Z" fill="#fff" fillOpacity="0.8" stroke="#ccc" strokeWidth="1" />
                <path d="M32 95 L68 95 L70 75 L30 75 Z" fill={color} />
                <circle cx="40" cy="85" r="4" fill="#000" />
                <circle cx="50" cy="90" r="4" fill="#000" />
                <circle cx="60" cy="82" r="4" fill="#000" />
                <circle cx="45" cy="78" r="4" fill="#000" />
                <circle cx="55" cy="88" r="4" fill="#000" />
                <rect x="48" y="5" width="4" height="65" fill={strawColor} rx="2" />
                <path d="M23 15 L77 15 L80 25 L20 25 Z" fill="#eee" stroke="#ccc" />
            </svg>
        );

        const ShopBackground = () => (
            <div className="absolute inset-x-0 top-0 h-32 flex flex-col overflow-hidden">
                <div className="flex justify-between mt-6 px-8 w-full z-10">
                    <div className="w-16 h-24 bg-slate-800 rounded-lg border-2 border-slate-700 flex flex-col items-center p-1 shadow-md">
                        <TapiocaDrink className="w-8 h-8 mb-1" color="#fcd34d" strawColor="#f87171" />
                        <div className="w-full h-0.5 bg-slate-600 mb-1" />
                        <div className="w-4/5 h-1 bg-amber-200 mb-1 opacity-50" />
                        <div className="w-3/4 h-1 bg-white mb-1 opacity-30" />
                    </div>
                    <div className="w-16 h-24 bg-slate-800 rounded-lg border-2 border-slate-700 flex flex-col items-center p-1 shadow-md">
                        <TapiocaDrink className="w-8 h-8 mb-1" color="#5c4033" strawColor="#60a5fa" />
                        <div className="w-full h-0.5 bg-slate-600 mb-1" />
                        <div className="w-4/5 h-1 bg-amber-200 mb-1 opacity-50" />
                        <div className="w-3/4 h-1 bg-white mb-1 opacity-30" />
                    </div>
                </div>
            </div>
        );

        const ClerkFace = ({ isSpeaking, onClick }) => (
            <div className="relative w-32 h-32 flex flex-col items-center justify-center cursor-pointer active:scale-95 transition-transform" onClick={onClick}>
                <div className="absolute top-4 w-20 h-16 bg-amber-900 rounded-t-full z-10" />
                <div className="relative w-20 h-20 bg-orange-50 rounded-full border-2 border-amber-100 flex flex-col items-center justify-center z-20 shadow-md">
                    <div className="flex gap-4 mb-2">
                        <div className="w-2 h-2 bg-slate-800 rounded-full" />
                        <div className="w-2 h-2 bg-slate-800 rounded-full" />
                    </div>
                    <div className={`w-6 h-3 bg-rose-300 rounded-full ${isSpeaking ? 'mouth-anim' : 'h-1'}`} />
                </div>
            </div>
        );

        const MoneyAsset = ({ value, onClick, region }) => {
            const isNote = region === 'china' ? true : value >= 100;
            const getColor = (v) => {
                if (v >= 5000) return 'bg-purple-200 border-purple-400 text-purple-700';
                if (v >= 1000) return 'bg-indigo-100 border-indigo-400 text-indigo-700';
                if (v >= 500) return 'bg-orange-100 border-orange-400 text-orange-700';
                if (v >= 100) return 'bg-rose-100 border-rose-400 text-rose-700';
                if (v >= 50) return 'bg-emerald-100 border-emerald-400 text-emerald-700';
                if (v >= 20) return 'bg-sky-100 border-sky-400 text-sky-700';
                if (v >= 10) return 'bg-slate-100 border-slate-400 text-slate-700';
                if (v >= 5) return 'bg-amber-100 border-amber-400 text-amber-700';
                return 'bg-white border-slate-300 text-slate-600';
            };
            const colorClasses = getColor(value);
            const sizeClass = isNote ? 'w-20 h-10 rounded-md' : 'w-12 h-12 rounded-full';

            return (
                <div onClick={() => onClick(value)} className={`${sizeClass} ${colorClasses.split(' ').slice(0,2).join(' ')} border flex items-center justify-center cursor-pointer shadow-sm hover:scale-105 active:scale-95 transition-all money-glow relative overflow-hidden flex-shrink-0`}>
                    <span className={`${colorClasses.split(' ')[2]} font-black text-xs sm:text-sm`}>{value.toLocaleString()}</span>
                </div>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState('title');
            const [region, setRegion] = useState('china');
            const [gameMode, setGameMode] = useState('challenge');
            const [targetAmount, setTargetAmount] = useState(0);
            const [currentTray, setCurrentTray] = useState([]);
            const [score, setScore] = useState(0);
            const [round, setRound] = useState(1);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [feedback, setFeedback] = useState(null);
            const [showHelp, setShowHelp] = useState(false);

            const denominations = [1, 5, 10, 20, 50, 100, 500, 1000, 5000];

            const speak = (amount, r = region) => {
                window.speechSynthesis.cancel();
                const msg = new SpeechSynthesisUtterance(`ä¸€å…±æ˜¯${amount}å…ƒ`);
                msg.lang = r === 'china' ? 'zh-CN' : 'zh-TW';
                msg.rate = 0.8;
                msg.onstart = () => setIsSpeaking(true);
                msg.onend = () => setIsSpeaking(false);
                window.speechSynthesis.speak(msg);
            };

            const generateNewRound = (r = region, curRound = round) => {
                setFeedback(null);
                let min = 1, max = 99;

                if (gameMode === 'challenge') {
                    // 10å•ãƒãƒ£ãƒ¬ãƒ³ã‚¸: 7å•ç›®ã¾ã§2æ¡ã€‚8å•ä»¥é™3æ¡ã€‚
                    if (curRound <= 7) {
                        min = 10; max = 99;
                    } else {
                        min = 100; max = 999;
                    }
                } else {
                    // ã‚µãƒã‚¤ãƒãƒ«: 10å•ç›®ã¾ã§2æ¡ã€11ã‹ã‚‰20å•ç›®ãŒ3æ¡ã€21ã‹ã‚‰30å•ç›®ãŒ4æ¡ã€41ï½50ãŒ2ï½4æ¡ã¾ã§ã®ãƒ©ãƒ³ãƒ€ãƒ 
                    // 31~40ã®å®šç¾©ãŒãªã‹ã£ãŸãŸã‚ã€å¾ã€…ã«é›£åŒ–ã•ã›ã‚‹è‡ªç„¶ãªæµã‚Œã¨ã—ã¦31~40ã‚‚4æ¡ã€41ä»¥é™ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®š
                    if (curRound <= 10) {
                        min = 10; max = 99;
                    } else if (curRound <= 20) {
                        min = 100; max = 999;
                    } else if (curRound <= 30) {
                        min = 1000; max = 9999;
                    } else if (curRound <= 40) {
                        min = 1000; max = 9999; // 30å°ã‚‚é«˜é›£æ˜“åº¦ç¶­æŒ
                    } else {
                        // 41~50ãŒ2~4æ¡ã¾ã§ã®ãƒ©ãƒ³ãƒ€ãƒ 
                        const digits = [10, 100, 1000][Math.floor(Math.random() * 3)];
                        min = digits;
                        max = digits * 10 - 1;
                    }
                }

                const newAmount = Math.floor(Math.random() * (max - min + 1)) + min;
                setTargetAmount(newAmount);
                setCurrentTray([]);
                setTimeout(() => speak(newAmount, r), 600);
            };

            const handleCheck = () => {
                const sum = currentTray.reduce((a, b) => a + b, 0);
                const isCorrect = sum === targetAmount;
                if (isCorrect) {
                    setFeedback({ type: 'success', text: 'å¤ªæ£’äº†ï¼(æ­£è§£ï¼)' });
                    setScore(s => s + 1);
                } else {
                    setFeedback({ type: 'fail', text: `ä¸å¯¹å“¦â€¦ æ­£è§£ã¯ ${targetAmount.toLocaleString()} å…ƒ` });
                }

                setTimeout(() => {
                    const maxRounds = gameMode === 'challenge' ? 10 : 50;
                    const nextRound = round + 1;

                    if (isCorrect) {
                        if (round >= maxRounds) {
                            setGameState('result');
                        } else {
                            setRound(nextRound);
                            generateNewRound(region, nextRound);
                        }
                    } else {
                        if (gameMode === 'challenge') {
                            if (round >= maxRounds) setGameState('result');
                            else {
                                setRound(nextRound);
                                generateNewRound(region, nextRound);
                            }
                        } else {
                            setGameState('result');
                        }
                    }
                }, 2000);
            };

            if (gameState === 'title') {
                return (
                    <div className="h-screen w-full max-w-md mx-auto relative bg-sky-50 flex flex-col items-center justify-center p-6 text-center overflow-hidden font-sans">
                        <div className="z-10 flex flex-col items-center">
                            <h1 className="text-2xl font-black text-sky-900 leading-tight">ä¸­å›½èªæ•°å­—ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚²ãƒ¼ãƒ <br/>ï¼œãŠä¼šè¨ˆç·¨ï¼</h1>
                            <div className="my-10">
                                <TapiocaDrink className="w-40 h-40 drop-shadow-xl" />
                            </div>
                            <button onClick={() => setGameState('regionSelect')} className="bg-sky-500 hover:bg-sky-600 text-white font-black text-2xl px-16 py-4 rounded-3xl shadow-xl transition-transform active:scale-95 mb-6 w-full max-w-xs">
                                ã‚¹ã‚¿ãƒ¼ãƒˆ
                            </button>
                            <button onClick={() => setShowHelp(true)} className="flex items-center gap-2 text-sky-600 font-bold hover:underline transition-all">
                                <IconInfo /> éŠã³æ–¹
                            </button>
                        </div>

                        {showHelp && (
                            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6">
                                <div className="bg-white rounded-[2rem] p-8 max-w-sm w-full shadow-2xl relative fade-in">
                                    <h3 className="text-xl font-black text-sky-900 mb-4">éŠã³æ–¹</h3>
                                    <div className="text-left space-y-4 text-sm font-bold text-slate-600">
                                        <p>1. åº—å“¡ã•ã‚“ãŒè¨€ã†åˆè¨ˆé‡‘é¡ã‚’èãå–ã‚Šã¾ã™ã€‚</p>
                                        <p>2. ä¸‹ã®ãŠé‡‘ã‚’é¸ã‚“ã§ãƒˆãƒ¬ã‚¤ã«ç½®ãã¾ã™ã€‚</p>
                                        <p>3. ã€Œæ”¯æ‰•ã†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç­”ãˆåˆã‚ã›ï¼</p>
                                    </div>
                                    <button onClick={() => setShowHelp(false)} className="mt-8 w-full bg-slate-800 text-white font-black py-3 rounded-2xl shadow-lg">ã¨ã˜ã‚‹</button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            if (gameState === 'regionSelect' || gameState === 'modeSelect') {
                const isRegion = gameState === 'regionSelect';
                return (
                    <div className="h-screen w-full max-w-md mx-auto relative bg-sky-50 flex flex-col items-center justify-center p-6">
                        <h2 className="text-2xl font-black text-sky-900 z-10 mb-8">{isRegion ? 'ã©ã“ã§ãŠè²·ã„ç‰©ã™ã‚‹ï¼Ÿ' : 'ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ'}</h2>
                        <div className="grid gap-6 w-full z-10 px-4">
                            {isRegion ? (
                                <>
                                    <button onClick={() => { setRegion('china'); setGameState('modeSelect'); }} className="bg-white p-6 rounded-3xl shadow-lg border-4 border-transparent hover:border-red-400 transition-all flex items-center gap-6 text-left">
                                        <div className="text-4xl">ğŸ‡¨ğŸ‡³</div>
                                        <div><div className="font-black text-xl text-slate-800">ä¸­å›½å¤§é™¸</div><div className="text-sm text-slate-500">é€šè²¨ï¼šäººæ°‘å…ƒ (å…ƒ/Â¥)</div></div>
                                    </button>
                                    <button onClick={() => { setRegion('taiwan'); setGameState('modeSelect'); }} className="bg-white p-6 rounded-3xl shadow-lg border-4 border-transparent hover:border-emerald-400 transition-all flex items-center gap-6 text-left">
                                        <div className="text-4xl">ğŸ‡¹ğŸ‡¼</div>
                                        <div><div className="font-black text-xl text-slate-800">å°æ¹¾</div><div className="text-sm text-slate-500">é€šè²¨ï¼šå°æ¹¾ãƒ‰ãƒ« (å…ƒ/NT$)</div></div>
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button onClick={() => { setGameMode('challenge'); setGameState('playing'); setRound(1); setScore(0); generateNewRound(region, 1); }} className="bg-white p-6 rounded-3xl shadow-lg border-4 border-sky-400 flex items-center gap-6 text-left">
                                        <div className="bg-sky-100 p-3 rounded-2xl text-sky-500 font-black">10</div>
                                        <div><div className="font-black text-xl text-slate-800">10å•ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div></div>
                                    </button>
                                    <button onClick={() => { setGameMode('survival'); setGameState('playing'); setRound(1); setScore(0); generateNewRound(region, 1); }} className="bg-white p-6 rounded-3xl shadow-lg border-4 border-rose-400 flex items-center gap-6 text-left">
                                        <div className="bg-rose-100 p-3 rounded-2xl text-rose-500">ğŸ”¥</div>
                                        <div><div className="font-black text-xl text-slate-800">ã‚µãƒã‚¤ãƒãƒ«</div><div className="text-sm text-slate-500">ä¸€å•ãƒŸã‚¹ã§çµ‚äº†ï¼æœ€å¤§50å•ã€‚</div></div>
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                );
            }

            if (gameState === 'playing') {
                const currentSum = currentTray.reduce((a, b) => a + b, 0);
                return (
                    <div className="h-screen w-full max-w-md mx-auto bg-sky-50 flex flex-col overflow-hidden relative">
                        <ShopBackground />
                        <div className="p-3 flex justify-between items-center z-30">
                            <button onClick={() => setGameState('title')} className="p-2 bg-white/80 rounded-full shadow text-sky-600"><IconHome /></button>
                            <div className="bg-white/80 px-4 py-1 rounded-full font-black text-sky-900 shadow-sm text-xs">
                                {gameMode === 'challenge' ? `ç¬¬ ${round} / 10 å•` : `ç¬¬ ${round} / 50 å• (ã‚¹ã‚³ã‚¢: ${score})`}
                            </div>
                            <div className="w-10"></div>
                        </div>
                        <div className="flex-grow flex flex-col items-center justify-start pt-4 px-2 z-20 relative">
                            <ClerkFace isSpeaking={isSpeaking} onClick={() => speak(targetAmount)} />
                            {feedback && (
                                <div className={`absolute top-4 px-6 py-2 rounded-2xl font-black text-lg shadow-xl fade-in z-50 text-center max-w-[90%] ${feedback.type === 'success' ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}`}>
                                    {feedback.text}
                                </div>
                            )}
                            
                            <div className="w-full mt-2 h-44 bg-white/60 backdrop-blur-sm border-4 border-dashed border-sky-200 rounded-3xl p-4 shadow-inner relative overflow-hidden">
                                <div className="w-full h-full overflow-y-auto tray-scroll pr-1">
                                    <div className="flex flex-wrap gap-3 content-start items-center justify-center min-h-full">
                                        {currentTray.length === 0 ? (
                                            <p className="text-sky-300 font-bold text-xs self-center">åº—å“¡ã•ã‚“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é‡‘é¡ã‚’èã“ã†</p>
                                        ) : (
                                            currentTray.map((v, i) => (
                                                <div key={i} onClick={() => { if(!feedback) setCurrentTray(currentTray.filter((_, idx) => idx !== i)) }}>
                                                    <MoneyAsset value={v} onClick={() => {}} region={region} />
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="bg-white rounded-t-[2.5rem] p-4 shadow-2xl z-30 mt-auto border-t-4 border-sky-100">
                            <div className="flex justify-between items-end mb-4 px-2">
                                <div>
                                    <span className="text-slate-400 font-bold text-[10px] block uppercase tracking-wider">æ”¯æ‰•ã†é‡‘é¡</span>
                                    <div className="flex items-baseline gap-1">
                                        <span className="text-3xl font-black text-sky-600 leading-none">{currentSum.toLocaleString()}</span>
                                        <span className="text-slate-600 font-bold text-sm">å…ƒ</span>
                                    </div>
                                </div>
                                <button onClick={handleCheck} className="bg-sky-500 text-white font-black text-base px-10 py-3 rounded-full shadow-lg active:scale-95 transition-transform disabled:opacity-50" disabled={currentSum === 0 || feedback !== null}>
                                    æ”¯æ‰•ã†
                                </button>
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                                {denominations.map(v => (
                                    <MoneyAsset key={v} value={v} onClick={(val) => { if(!feedback) setCurrentTray([...currentTray, val])}} region={region} />
                                ))}
                            </div>
                            <button onClick={() => { if(!feedback) setCurrentTray([]) }} className="w-full mt-2 text-slate-300 font-bold text-[10px] hover:text-red-400 py-1 uppercase tracking-widest">Clear All</button>
                        </div>
                    </div>
                );
            }

            if (gameState === 'result') {
                return (
                    <div className="h-screen w-full max-w-md mx-auto bg-sky-50 flex flex-col items-center justify-center p-8">
                        <div className="bg-white rounded-[3rem] shadow-2xl p-10 w-full text-center z-10 border-8 border-sky-100">
                            <h2 className="text-3xl font-black text-sky-900 mb-6">çµæœç™ºè¡¨ï¼</h2>
                            <div className="text-xl font-bold text-slate-500 mb-2">{gameMode === 'challenge' ? 'æ­£è§£æ•°' : 'æœ€çµ‚ã‚¹ã‚³ã‚¢'}</div>
                            <div className="text-7xl font-black text-rose-500 mb-4">{score}</div>
                            <div className="space-y-4 mt-8">
                                <button onClick={() => setGameState('title')} className="w-full bg-sky-500 text-white font-black py-4 rounded-2xl shadow-lg">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
                                <button onClick={() => { setRound(1); setScore(0); setGameState('playing'); generateNewRound(region, 1); }} className="w-full bg-emerald-500 text-white font-black py-4 rounded-2xl shadow-lg">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
                            </div>
                        </div>
                    </div>
                );
            }
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
